<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>panda_gazebo.core.control_server &mdash; Panda Gazebo 2.17.6 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/modify.css?v=519ed47b" />

  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=fe1d5c58"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.17.6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/usage.html">How to use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/issues.html">Known Issues</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/contributing.html">Contribute to panda-gazebo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/doc_dev.html">Release documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev/license.html">License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Panda Gazebo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../panda_gazebo.html">panda_gazebo</a></li>
      <li class="breadcrumb-item active">panda_gazebo.core.control_server</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for panda_gazebo.core.control_server</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;This server is responsible for controlling the Panda arm. It created several</span>
<span class="sd">(action) services that can be used to send control commands to the Panda Robot arm and</span>
<span class="sd">hand. These services wrap around the original control topics and services created by</span>
<span class="sd">the `franka_ros`_ and `ros_control`_ packages and add extra functionality. They allow</span>
<span class="sd">you to ``wait`` for control commands to be completed, send incomplete control commands</span>
<span class="sd">and incomplete trajectories (i.e. control commands/trajectories that do not contain</span>
<span class="sd">all the joints).</span>

<span class="sd">Main services:</span>
<span class="sd">    * ``get_controlled_joints``</span>
<span class="sd">    * ``follow_joint_trajectory``</span>
<span class="sd">    * ``set_joint_commands``</span>
<span class="sd">    * ``panda_hand/set_gripper_width``</span>

<span class="sd">Main actions:</span>
<span class="sd">    * ``panda_arm/follow_joint_trajectory``</span>

<span class="sd">Extra services:</span>
<span class="sd">    * ``panda_arm/set_joint_positions``</span>
<span class="sd">    * ``panda_arm/set_joint_efforts``</span>

<span class="sd">.. _`franka_ros`: https://github.com/frankaemika/franka_ros</span>
<span class="sd">.. _`ros_control`: https://github.com/ros-controls/ros_control</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">compress</span>

<span class="kn">import</span> <span class="nn">control_msgs.msg</span> <span class="k">as</span> <span class="nn">control_msgs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">actionlib</span> <span class="kn">import</span> <span class="n">SimpleActionClient</span><span class="p">,</span> <span class="n">SimpleActionServer</span>
<span class="kn">from</span> <span class="nn">actionlib_msgs.msg</span> <span class="kn">import</span> <span class="n">GoalStatus</span>
<span class="kn">from</span> <span class="nn">control_msgs.msg</span> <span class="kn">import</span> <span class="n">GripperCommandAction</span><span class="p">,</span> <span class="n">GripperCommandGoal</span>
<span class="kn">from</span> <span class="nn">controller_manager_msgs.srv</span> <span class="kn">import</span> <span class="n">ListControllers</span><span class="p">,</span> <span class="n">ListControllersRequest</span>
<span class="kn">from</span> <span class="nn">rospy.exceptions</span> <span class="kn">import</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span>
<span class="kn">from</span> <span class="nn">sensor_msgs.msg</span> <span class="kn">import</span> <span class="n">JointState</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Float64MultiArray</span>

<span class="kn">from</span> <span class="nn">panda_gazebo.common</span> <span class="kn">import</span> <span class="n">ControlledJointsDict</span>
<span class="kn">from</span> <span class="nn">panda_gazebo.common.helpers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">action_server_exists</span><span class="p">,</span>
    <span class="n">controller_list_array_2_dict</span><span class="p">,</span>
    <span class="n">get_duplicate_list</span><span class="p">,</span>
    <span class="n">get_unique_list</span><span class="p">,</span>
    <span class="n">list_2_human_text</span><span class="p">,</span>
    <span class="n">lower_first_char</span><span class="p">,</span>
    <span class="n">panda_action_msg_2_control_msgs_action_msg</span><span class="p">,</span>
    <span class="n">ros_exit_gracefully</span><span class="p">,</span>
    <span class="n">translate_actionclient_result_error_code</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">panda_gazebo.exceptions</span> <span class="kn">import</span> <span class="n">InputMessageInvalidError</span>
<span class="kn">from</span> <span class="nn">panda_gazebo.msg</span> <span class="kn">import</span> <span class="n">FollowJointTrajectoryAction</span><span class="p">,</span> <span class="n">FollowJointTrajectoryResult</span>
<span class="kn">from</span> <span class="nn">panda_gazebo.srv</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GetControlledJoints</span><span class="p">,</span>
    <span class="n">GetControlledJointsResponse</span><span class="p">,</span>
    <span class="n">SetGripperWidth</span><span class="p">,</span>
    <span class="n">SetGripperWidthRequest</span><span class="p">,</span>
    <span class="n">SetGripperWidthResponse</span><span class="p">,</span>
    <span class="n">SetJointCommands</span><span class="p">,</span>
    <span class="n">SetJointCommandsResponse</span><span class="p">,</span>
    <span class="n">SetJointEfforts</span><span class="p">,</span>
    <span class="n">SetJointEffortsResponse</span><span class="p">,</span>
    <span class="n">SetJointPositions</span><span class="p">,</span>
    <span class="n">SetJointPositionsResponse</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Global script variables.</span>
<div class="viewcode-block" id="GRASP_EPSILON"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.GRASP_EPSILON">[docs]</a><span class="n">GRASP_EPSILON</span> <span class="o">=</span> <span class="mf">0.003</span>  <span class="c1"># NOTE: Uses &#39;kGraspRestingThreshold&#39; from &#39;franka_gripper.sim.h&#39;</span></div>
<div class="viewcode-block" id="GRASP_SPEED"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.GRASP_SPEED">[docs]</a><span class="n">GRASP_SPEED</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># NOTE: Uses &#39;kDefaultGripperActionSpeed&#39; from &#39;franka_gripper.sim.h&#39;</span></div>
<div class="viewcode-block" id="GRASP_FORCE"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.GRASP_FORCE">[docs]</a><span class="n">GRASP_FORCE</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Panda force information: {continuous force: 70N, max_force: 140 N}</span></div>
<div class="viewcode-block" id="GRIPPER_ACTION_TIMEOUT"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.GRIPPER_ACTION_TIMEOUT">[docs]</a><span class="n">GRIPPER_ACTION_TIMEOUT</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">5</span>  <span class="c1"># How long to wait for the &#39;franka_gripper&#39; action to finish [s].  # noqa: E501</span>
<span class="p">)</span></div>
<div class="viewcode-block" id="DIRNAME"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.DIRNAME">[docs]</a><span class="n">DIRNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span></div>
<div class="viewcode-block" id="PANDA_JOINTS"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.PANDA_JOINTS">[docs]</a><span class="n">PANDA_JOINTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;arm&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;panda_joint1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;panda_joint7&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;hand&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;panda_finger_joint1&quot;</span><span class="p">,</span> <span class="s2">&quot;panda_finger_joint2&quot;</span><span class="p">],</span>
<span class="p">}</span></div>
<div class="viewcode-block" id="ARM_POSITION_CONTROLLER"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.ARM_POSITION_CONTROLLER">[docs]</a><span class="n">ARM_POSITION_CONTROLLER</span> <span class="o">=</span> <span class="s2">&quot;panda_arm_joint_position_controller&quot;</span></div>
<div class="viewcode-block" id="ARM_EFFORT_CONTROLLER"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.ARM_EFFORT_CONTROLLER">[docs]</a><span class="n">ARM_EFFORT_CONTROLLER</span> <span class="o">=</span> <span class="s2">&quot;panda_arm_joint_effort_controller&quot;</span></div>
<div class="viewcode-block" id="ARM_TRAJ_CONTROLLER"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.ARM_TRAJ_CONTROLLER">[docs]</a><span class="n">ARM_TRAJ_CONTROLLER</span> <span class="o">=</span> <span class="s2">&quot;panda_arm_trajectory_controller&quot;</span></div>
<div class="viewcode-block" id="HAND_CONTROLLER"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.HAND_CONTROLLER">[docs]</a><span class="n">HAND_CONTROLLER</span> <span class="o">=</span> <span class="s2">&quot;franka_gripper&quot;</span></div>
<div class="viewcode-block" id="CONTROLLER_INFO_RATE"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.CONTROLLER_INFO_RATE">[docs]</a><span class="n">CONTROLLER_INFO_RATE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">10</span>  <span class="c1"># Rate [hz] for retrieving controller information.</span></div>
<div class="viewcode-block" id="CONNECTION_TIMEOUT"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.CONNECTION_TIMEOUT">[docs]</a><span class="n">CONNECTION_TIMEOUT</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Service connection timeout [s].</span></div>


<div class="viewcode-block" id="PandaControlServer"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/index.html#panda_gazebo.core.control_server.PandaControlServer">[docs]</a><span class="k">class</span> <span class="nc">PandaControlServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Controller server used to send control commands to the simulated Panda Robot.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        joint_states (:obj:`sensor_msgs.JointState`): The current joint states.</span>
<span class="sd">        arm_joint_positions_threshold (float): The current threshold for determining</span>
<span class="sd">            whether the arm joint positions are within the given setpoint.</span>
<span class="sd">        arm_joint_efforts_threshold (float): The current threshold for determining</span>
<span class="sd">            whether the arm joint efforts are within the given setpoint.</span>
<span class="sd">        arm_velocity_threshold (float): The current threshold for determining whether</span>
<span class="sd">            the arm has zero velocity.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">autofill_traj_positions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">load_gripper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">load_set_joint_commands_service</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">load_arm_follow_joint_trajectory_action</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">load_extra_services</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">controllers_check_rate</span><span class="o">=</span><span class="n">CONTROLLER_INFO_RATE</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise PandaControlServer object.</span>

<span class="sd">        Args:</span>
<span class="sd">            autofill_traj_positions (bool, optional): Whether you want to automatically</span>
<span class="sd">                set the current states as positions when the positions field of the</span>
<span class="sd">                joint trajectory message is left empty. Defaults to ``False``.</span>
<span class="sd">            load_gripper (boolean, optional): Whether we also want to load the gripper</span>
<span class="sd">                control services.</span>
<span class="sd">            load_set_joint_commands_service (boolean, optional): Whether the set joint</span>
<span class="sd">                commands service should be loaded. This service is used by the</span>
<span class="sd">                :ros-gazebo-gym:`ros_gazebo_gym &lt;&gt;` package when the control type is</span>
<span class="sd">                **NOT** set to ``trajectory``. Defaults, to ``True``.</span>
<span class="sd">            load_arm_follow_joint_trajectory_action (boolean, optional): Whether the</span>
<span class="sd">                arm follow joint trajectory action should be loaded. This service is</span>
<span class="sd">                used by the :ros-gazebo-gym:`ros_gazebo_gym &lt;&gt;` package when the control</span>
<span class="sd">                type is set to ``trajectory``. Defaults, to ``False``.</span>
<span class="sd">            load_extra_services (bool, optional): Whether to load extra services that</span>
<span class="sd">                are not used by the :ros-gazebo-gym:`ros_gazebo_gym &lt;&gt;` package.</span>
<span class="sd">                Defaults to ``False``.</span>
<span class="sd">            controllers_check_rate (float, optional): Rate at which the availability of</span>
<span class="sd">                the used controllers is checked. Setting this to ``-1`` will check at</span>
<span class="sd">                every time step. Defaults to ``0.1`` Hz.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Please note that increasing the ``controllers_check_rate`` decreases the</span>
<span class="sd">            control frequency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arm_joint_positions_threshold</span> <span class="o">=</span> <span class="mf">0.07</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arm_joint_efforts_threshold</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arm_velocity_threshold</span> <span class="o">=</span> <span class="mf">0.07</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_autofill_traj_positions</span> <span class="o">=</span> <span class="n">autofill_traj_positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span> <span class="o">=</span> <span class="n">load_gripper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_controllers_check_rate</span> <span class="o">=</span> <span class="n">controllers_check_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__controller_check_t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__controllers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__controlled_joints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__joint_controllers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Disable the `gripper_action` gripper width reached check.</span>
        <span class="c1"># NOTE: Done to allow grasping with the `gripper_action` service (see #33).</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s2">&quot;/franka_gripper/gripper_action/width_tolerance&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Create Panda control services ########</span>
        <span class="c1">########################################</span>

        <span class="c1"># Create main PandaControlServer services.</span>
        <span class="c1"># NOTE: These services wrap around the controller command topics created by</span>
        <span class="c1"># the `ros_control` package to allow the user to wait for control commands</span>
        <span class="c1"># and specify incomplete joint control commands (i.e. joint commands that do</span>
        <span class="c1"># not contain all the joints).</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Creating &#39;</span><span class="si">%s</span><span class="s2">&#39; services.&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
            <span class="s2">&quot;Creating &#39;</span><span class="si">%s</span><span class="s2">/get_controlled_joints&#39; service.&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_controlled_joints_srv</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/get_controlled_joints&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">GetControlledJoints</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_controlled_joints_cb</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">load_set_joint_commands_service</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Creating &#39;</span><span class="si">%s</span><span class="s2">/set_joint_commands&#39; service.&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_joint_commands_srv</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/set_joint_commands&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">SetJointCommands</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_joint_commands_cb</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">load_extra_services</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Creating &#39;</span><span class="si">%s</span><span class="s2">/panda_arm/set_joint_positions&#39; service.&quot;</span>
                <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_arm_joint_positions_srv</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/panda_arm/set_joint_positions&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">SetJointPositions</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_arm_set_joint_positions_cb</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Creating &#39;</span><span class="si">%s</span><span class="s2">/panda_arm/set_joint_efforts&#39; service.&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_arm_joint_efforts_srv</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/panda_arm/set_joint_efforts&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">SetJointEfforts</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_arm_set_joint_efforts_cb</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># NOTE: The service below serves as a wrapper around the original</span>
        <span class="c1"># &#39;franka_gripper&#39; grasp and move actions. It makes sure that the right action</span>
        <span class="c1"># is called and that users only need to set the gripper width while it</span>
        <span class="c1"># automatically sets the speed, epsilon and force. It also clips gripper width</span>
        <span class="c1"># that are not possible.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Creating &#39;</span><span class="si">%s</span><span class="s2">/panda_hand/set_gripper_width&#39; service.&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_gripper_width_srv</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/panda_hand/set_gripper_width&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">SetGripperWidth</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_gripper_width_cb</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; services created successfully.&quot;</span> <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">())</span>

        <span class="c1">########################################</span>
        <span class="c1"># Create panda_control publishers and ##</span>
        <span class="c1"># and connect to required (action) #####</span>
        <span class="c1"># services and messages. ###############</span>
        <span class="c1">########################################</span>
        <span class="k">if</span> <span class="n">load_set_joint_commands_service</span><span class="p">:</span>
            <span class="c1"># Create arm joint position controller publisher.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_position_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/command&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ARM_POSITION_CONTROLLER</span><span class="p">),</span>
                <span class="n">Float64MultiArray</span><span class="p">,</span>
                <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Create arm joint effort publisher.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_effort_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/command&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ARM_EFFORT_CONTROLLER</span><span class="p">),</span> <span class="n">Float64MultiArray</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>

        <span class="c1"># Connect to controller_manager services.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connecting to &#39;controller_manager/list_controllers&#39; service.&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span>
                <span class="s2">&quot;controller_manager/list_controllers&quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">from_sec</span><span class="p">(</span><span class="n">CONNECTION_TIMEOUT</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_list_controllers_client</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span>
                <span class="s2">&quot;controller_manager/list_controllers&quot;</span><span class="p">,</span> <span class="n">ListControllers</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connected to &#39;controller_manager/list_controllers&#39; service!&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span><span class="p">,</span> <span class="n">ROSException</span><span class="p">,</span> <span class="n">ROSInterruptException</span><span class="p">):</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Shutting down &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; because no connection could be &quot;</span>
                <span class="s2">&quot;established with the &#39;controller_manager/list_controllers&#39; service.&quot;</span>
            <span class="p">)</span>
            <span class="n">ros_exit_gracefully</span><span class="p">(</span><span class="n">shutdown_message</span><span class="o">=</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Connect to the gripper command action server.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
            <span class="n">franka_gripper_command_topic</span> <span class="o">=</span> <span class="s2">&quot;franka_gripper/gripper_action&quot;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connecting to &#39;</span><span class="si">%s</span><span class="s2">&#39; action service.&quot;</span> <span class="o">%</span> <span class="n">franka_gripper_command_topic</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">action_server_exists</span><span class="p">(</span><span class="n">franka_gripper_command_topic</span><span class="p">):</span>
                <span class="c1"># Connect to robot control action server.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span> <span class="o">=</span> <span class="n">SimpleActionClient</span><span class="p">(</span>
                    <span class="n">franka_gripper_command_topic</span><span class="p">,</span>
                    <span class="n">GripperCommandAction</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Waits until the action server has started up.</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">from_sec</span><span class="p">(</span><span class="n">CONNECTION_TIMEOUT</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">retval</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                        <span class="s2">&quot;No connection could be established with the &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">franka_gripper_command_topic</span><span class="si">}</span><span class="s2">&#39; service. The Panda Robot &quot;</span>
                        <span class="s2">&quot;environment therefore can not use this action service to &quot;</span>
                        <span class="s2">&quot;control the Panda Robot.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;No connection could be established with the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">franka_gripper_command_topic</span><span class="si">}</span><span class="s2">&#39; service. The Panda Robot &quot;</span>
                    <span class="s2">&quot;environment therefore can not use this action service to control &quot;</span>
                    <span class="s2">&quot;the Panda Robot.&quot;</span>
                <span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Connect joint state subscriber #######</span>
        <span class="c1">########################################</span>

        <span class="c1"># Retrieve current robot joint state and effort information.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_message</span><span class="p">(</span>
                    <span class="s2">&quot;joint_states&quot;</span><span class="p">,</span> <span class="n">JointState</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">ROSException</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;Current joint_states not ready yet, retrying for getting &quot;</span>
                    <span class="s2">&quot;&#39;joint_states&#39;&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Create joint_state subscriber.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joint_states_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span>
            <span class="s2">&quot;joint_states&quot;</span><span class="p">,</span> <span class="n">JointState</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joint_states_cb</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1">########################################</span>
        <span class="c1"># Create joint trajectory action #######</span>
        <span class="c1"># servers ##############################</span>
        <span class="c1">########################################</span>
        <span class="c1"># NOTE: Here setup a new action service that serves as a wrapper around the</span>
        <span class="c1"># original &#39;panda_arm_trajectory_controller/follow_joint_trajectory&#39;. By doing</span>
        <span class="c1"># this we add the following features to the original action servers.</span>
        <span class="c1">#   - The ability to send partial joint messages.</span>
        <span class="c1">#   - The ability to send joint trajectory messages that do not specify joints.</span>
        <span class="c1">#   - The ability to automatic generate a time axes when the create_time_axis</span>
        <span class="c1">#     field is set to True.</span>
        <span class="k">if</span> <span class="n">load_arm_follow_joint_trajectory_action</span><span class="p">:</span>
            <span class="c1"># Connect to the &#39;panda_arm_trajectory_controller/follow_joint_trajectory&#39;</span>
            <span class="c1"># action server.</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Connecting to &#39;</span><span class="si">{}</span><span class="s2">&#39; action service.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;panda_arm_trajectory_controller/follow_joint_trajectory&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">action_server_exists</span><span class="p">(</span>
                <span class="s2">&quot;panda_arm_trajectory_controller/follow_joint_trajectory&quot;</span>
            <span class="p">):</span>
                <span class="c1"># Connect to robot control action server.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client</span> <span class="o">=</span> <span class="n">SimpleActionClient</span><span class="p">(</span>
                    <span class="s2">&quot;panda_arm_trajectory_controller/follow_joint_trajectory&quot;</span><span class="p">,</span>
                    <span class="n">control_msgs</span><span class="o">.</span><span class="n">FollowJointTrajectoryAction</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Waits until the action server has started up.</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">secs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">retval</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                        <span class="s2">&quot;No connection could be established with the &quot;</span>
                        <span class="s2">&quot;&#39;panda_arm_trajectory_controller/follow_joint_trajectory&#39; &quot;</span>
                        <span class="s2">&quot;service. The Panda Robot Environment therefore can not use &quot;</span>
                        <span class="s2">&quot;this action service to control the Panda Robot.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="s2">&quot;No connection could be established with the &quot;</span>
                    <span class="s2">&quot;&#39;panda_arm_trajectory_controller/follow_joint_trajectory&#39; &quot;</span>
                    <span class="s2">&quot;service. The Panda Robot Environment therefore can not use this &quot;</span>
                    <span class="s2">&quot;action service to control the Panda Robot.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Setup a new Panda arm joint trajectory action server.</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span>
                <span class="s2">&quot;Creating &#39;</span><span class="si">%s</span><span class="s2">/panda_arm/follow_joint_trajectory&#39; service.&quot;</span>
                <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span> <span class="o">=</span> <span class="n">SimpleActionServer</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/panda_arm/follow_joint_trajectory&quot;</span>
                <span class="o">%</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">FollowJointTrajectoryAction</span><span class="p">,</span>
                <span class="n">execute_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_execute_cb</span><span class="p">,</span>
                <span class="n">auto_start</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span><span class="o">.</span><span class="n">register_preempt_callback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_preempt_cb</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1">################################################</span>
    <span class="c1"># Panda control member functions ###############</span>
    <span class="c1">################################################</span>
    <span class="k">def</span> <span class="nf">_wait_till_arm_control_done</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">control_type</span><span class="p">,</span>
        <span class="n">joint_setpoint</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">check_gradient</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait till arm control is finished. Meaning the robot state is within range</span>
<span class="sd">        of the joint position and joint effort setpoints (or the velocity is zero).</span>

<span class="sd">        Args:</span>
<span class="sd">            control_type (str): The type of control that is being executed and on which</span>
<span class="sd">                we should wait. Options are ``effort`` and ``position``.</span>
<span class="sd">            joint_setpoint (list): The setpoint to wait for.</span>
<span class="sd">            timeout (int, optional): The timeout when waiting for the control</span>
<span class="sd">                to be done. Defaults to ``5``.</span>
<span class="sd">            check_gradient (boolean, optional): If enabled the script will also return</span>
<span class="sd">                when the gradients become zero. Defaults to ``True``.</span>

<span class="sd">        Raises:</span>
<span class="sd">            :obj:`ValueError`: Raised when the control_type is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">control_type</span> <span class="o">=</span> <span class="n">control_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">control_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Please specify a valid control type. Valid values are &#39;position&#39; &amp; &quot;</span>
                <span class="s2">&quot;&#39;effort&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Compute the state masks.</span>
        <span class="n">arm_states_mask</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlled_joints</span><span class="p">[</span><span class="n">control_type</span><span class="p">][</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">arm_states_mask</span><span class="p">):</span>
            <span class="n">controller</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ARM_POSITION_CONTROLLER</span>
                <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
                <span class="k">else</span> <span class="n">ARM_EFFORT_CONTROLLER</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Not waiting for control to be completed as no joints appear to be &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;controlled when using &#39;</span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">&#39; control. Please make sure the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">controller</span><span class="si">}</span><span class="s2">&#39; controller that is needed for &#39;</span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="s2">&quot;control is loaded.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Wait till robot positions/efforts reach the setpoint or the velocities are</span>
        <span class="c1"># not changing anymore.</span>
        <span class="n">timeout_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_rostime</span><span class="p">()</span> <span class="o">+</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">from_sec</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">()</span> <span class="ow">and</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_rostime</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">timeout_time</span><span class="p">:</span>
            <span class="n">joint_states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="n">compress</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">position</span>
                        <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">effort</span><span class="p">,</span>
                        <span class="n">arm_states_mask</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">state_threshold</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arm_joint_positions_threshold</span>
                <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_joint_efforts_threshold</span>
            <span class="p">)</span>
            <span class="n">grad_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_velocity_threshold</span>
            <span class="n">joint_setpoint_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">joint_setpoint</span><span class="p">),</span>
                <span class="n">joint_states</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_setpoint</span><span class="p">)</span> <span class="p">:],</span>  <span class="c1"># noqa: E203, E501</span>
            <span class="p">)</span>

            <span class="c1"># Add current state to state_buffer and delete oldest entry.</span>
            <span class="n">state_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_states</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">grad_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_states</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">state_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_buffer</span><span class="p">,</span> <span class="p">[</span><span class="n">joint_states</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">grad_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">state_buffer</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Check if setpoint is reached.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">joint_states</span> <span class="o">-</span> <span class="n">joint_setpoint_tmp</span><span class="p">)</span>
                <span class="o">&lt;=</span> <span class="n">state_threshold</span>  <span class="c1"># Check if difference norm is within threshold.</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">check_gradient</span>
                <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">grad_threshold</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">grad_buffer</span><span class="p">[</span>
                        <span class="o">-</span><span class="mi">1</span>
                    <span class="p">]</span>  <span class="c1"># Check if all velocities are close to zero.</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_create_arm_traj_action_server_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_msg</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts the ``control_msgs.msg.FollowJointTrajectoryGoal`` message that</span>
<span class="sd">        is received by the ``panda_control_server`` follow joint trajectory wrapper</span>
<span class="sd">        action servers into the right format for the original ``panda_arm_trajectory_controller``</span>
<span class="sd">        `follow_joint_trajectory &lt;https://wiki.ros.org/joint_trajectory_action/&gt;`_</span>
<span class="sd">        action server.</span>

<span class="sd">        By doing this, we allow our users to send incomplete joint trajectory messages</span>
<span class="sd">        (i.e., joint trajectory messages that do not contain all the joints). We also</span>
<span class="sd">        allow them to generate the time axes automatically when the ``create_time_axis``</span>
<span class="sd">        field is set to ``True``.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_msg (:obj:`trajectory_msgs/JointTrajectory`): The service input</span>
<span class="sd">                message we want to validate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the arm and hand panda_arm_trajectory_controller</span>
<span class="sd">                :control_msgs:`control_msgs.msg.FollowJointTrajectoryGoal &lt;html/action/FollowJointTrajectory.html&gt;`</span>
<span class="sd">                messages.</span>

<span class="sd">        Raises:</span>
<span class="sd">            :obj:`panda_gazebo.exceptions.InputMessageInvalidError`: Raised when the</span>
<span class="sd">                input_msg could not be converted into panda_arm_trajectory_controller control</span>
<span class="sd">                messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="c1"># Retrieve controlled joints and current state of the controlled arm joints.</span>
        <span class="n">input_joints</span> <span class="o">=</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">joint_names</span>
        <span class="n">controlled_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlled_joints</span><span class="p">[</span><span class="s2">&quot;trajectory&quot;</span><span class="p">][</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
        <span class="n">controlled_joints_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">controlled_joints</span><span class="p">)</span>
        <span class="n">joint_states_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">effort</span><span class="p">,</span> <span class="n">velocity</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">effort</span><span class="p">,</span> <span class="n">velocity</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">effort</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">}</span>
        <span class="n">current_controlled_arm_state</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">joint_states_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">controlled_joints</span>
            <span class="p">],</span>
            <span class="s2">&quot;effort&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">joint_states_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">controlled_joints</span>
            <span class="p">],</span>
            <span class="s2">&quot;velocities&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">states</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">joint_states_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">controlled_joints</span>
            <span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Initialise new arm action server messages using the current robot state.</span>
        <span class="n">arm_control_msg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_msg</span><span class="p">)</span>
        <span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">joint_names</span> <span class="o">=</span> <span class="n">controlled_joints</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">):</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">point</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_controlled_arm_state</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">])</span>
            <span class="n">point</span><span class="o">.</span><span class="n">effort</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_controlled_arm_state</span><span class="p">[</span><span class="s2">&quot;effort&quot;</span><span class="p">])</span>
            <span class="n">point</span><span class="o">.</span><span class="n">velocities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">current_controlled_arm_state</span><span class="p">[</span><span class="s2">&quot;velocities&quot;</span><span class="p">])</span>
            <span class="n">point</span><span class="o">.</span><span class="n">accelerations</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span>

        <span class="c1"># Retrieve the length of the positions/velocities/accelerations and efforts</span>
        <span class="c1"># fields in all the trajectory waypoints.</span>
        <span class="n">waypoints</span> <span class="o">=</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span>
        <span class="n">waypoints_lengths_array</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">positions</span><span class="p">)</span> <span class="k">for</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="n">waypoints</span><span class="p">],</span>
            <span class="s2">&quot;effort&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">effort</span><span class="p">)</span> <span class="k">for</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="n">waypoints</span><span class="p">],</span>
            <span class="s2">&quot;velocities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">velocities</span><span class="p">)</span> <span class="k">for</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="n">waypoints</span><span class="p">],</span>
            <span class="s2">&quot;accelerations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">waypoint</span><span class="o">.</span><span class="n">accelerations</span><span class="p">)</span> <span class="k">for</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="n">waypoints</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Validate time axis step size and throw warning if invalid.</span>
        <span class="k">if</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">create_time_axis</span> <span class="ow">and</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">time_axis_step</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;A time axis step size of &#39;</span><span class="si">{</span><span class="n">input_msg</span><span class="o">.</span><span class="n">time_axis_step</span><span class="si">}</span><span class="s2">&#39; is not &quot;</span>
                <span class="s2">&quot;supported. Please supply a time axis step greater than 0.0 if you &quot;</span>
                <span class="s2">&quot;want to automatically create the trajectory time axis.&quot;</span>
            <span class="p">)</span>
            <span class="n">input_msg</span><span class="o">.</span><span class="n">create_time_axis</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Disable time axis generation.</span>

        <span class="c1"># Check action server goal request message.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_joints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If not joint_names were given.</span>
            <span class="c1"># Check if enough control values were given for the requested joints and</span>
            <span class="c1"># throw error if to many were given and warning if to few were given.</span>
            <span class="n">waypoint_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">,</span> <span class="s2">&quot;velocities&quot;</span><span class="p">,</span> <span class="s2">&quot;accelerations&quot;</span><span class="p">]</span>
            <span class="n">waypoints_lengths_to_big</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">waypoints_lengths_to_small</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">waypoint_type</span> <span class="ow">in</span> <span class="n">waypoint_types</span><span class="p">:</span>
                <span class="n">lengths</span> <span class="o">=</span> <span class="n">waypoints_lengths_array</span><span class="p">[</span><span class="n">waypoint_type</span><span class="p">]</span>
                <span class="n">waypoints_lengths_to_big</span><span class="p">[</span><span class="n">waypoint_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">length</span> <span class="o">&gt;</span> <span class="n">controlled_joints_size</span> <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">lengths</span>
                <span class="p">)</span>
                <span class="n">waypoints_lengths_to_small</span><span class="p">[</span><span class="n">waypoint_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">length</span> <span class="o">&lt;</span> <span class="n">controlled_joints_size</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">lengths</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">waypoints_lengths_to_big</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">invalid_fields_string</span> <span class="o">=</span> <span class="n">list_2_human_text</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">waypoints_lengths_to_big</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">val</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">logwarn_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Your joint trajectory goal message contains more joint &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">invalid_fields_string</span><span class="si">}</span><span class="s2"> than the </span><span class="si">{</span><span class="n">controlled_joints_size</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;joints that are found in the arm control group.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">InputMessageInvalidError</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid number of joint position commands.&quot;</span><span class="p">,</span>
                    <span class="n">log_message</span><span class="o">=</span><span class="n">logwarn_message</span><span class="p">,</span>
                    <span class="n">controlled_joints</span><span class="o">=</span><span class="n">controlled_joints_size</span><span class="p">,</span>
                    <span class="n">error_code</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">waypoints_lengths_to_small</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">invalid_fields_string</span> <span class="o">=</span> <span class="n">list_2_human_text</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">waypoints_lengths_to_small</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">val</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">logwarn_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Some of the trajectory waypoints contain less &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">invalid_fields_string</span><span class="si">}</span><span class="s2"> commands than &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">controlled_joints_size</span><span class="si">}</span><span class="s2"> joints that are found in the arm &quot;</span>
                    <span class="s2">&quot;control group. When this is the case the current joint states &quot;</span>
                    <span class="s2">&quot;will be used for the joints without a position command.&quot;</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span><span class="n">logwarn_message</span><span class="p">)</span>

            <span class="c1"># Iterates through waypoints to construct new joint trajectory control</span>
            <span class="c1"># message.</span>
            <span class="c1"># NOTE: Empty fields are preserved for consistency with the original action</span>
            <span class="c1"># server except when &#39;autofill_traj_positions&#39; is set to True. In that case</span>
            <span class="c1"># we make sure to always populate &#39;positions&#39; with current joint states.</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">):</span>
                <span class="c1"># Add time_from_start variable if time axis should be created.</span>
                <span class="k">if</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">create_time_axis</span><span class="p">:</span>
                    <span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span>
                        <span class="n">idx</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">time_from_start</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">from_sec</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">time_axis_step</span>
                    <span class="p">)</span>

                <span class="c1"># Add joint commands.</span>
                <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">,</span> <span class="s2">&quot;velocities&quot;</span><span class="p">,</span> <span class="s2">&quot;accelerations&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                    <span class="n">waypoint_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">waypoint</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">waypoint</span><span class="p">,</span> <span class="n">attribute</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">attribute</span><span class="p">)[</span>
                            <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">waypoint_attr</span><span class="p">)</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">waypoint_attr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Make sure empty field stays empty.</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">attribute</span> <span class="o">==</span> <span class="s2">&quot;positions&quot;</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autofill_traj_positions</span>
                        <span class="p">):</span>
                            <span class="nb">getattr</span><span class="p">(</span>
                                <span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">attribute</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">getattr</span><span class="p">(</span>
                                <span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">attribute</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">panda_action_msg_2_control_msgs_action_msg</span><span class="p">(</span><span class="n">arm_control_msg</span><span class="p">)</span>

        <span class="c1"># Check if enough control values were given for the requested joints and throw</span>
        <span class="c1"># error if needed.</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">,</span> <span class="s2">&quot;velocities&quot;</span><span class="p">,</span> <span class="s2">&quot;accelerations&quot;</span><span class="p">]</span>
        <span class="n">waypoints_length_not_equal</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">length</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_joints</span><span class="p">)</span> <span class="ow">and</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">waypoints_lengths_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">waypoints_length_not_equal</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">invalid_fields_string</span> <span class="o">=</span> <span class="n">list_2_human_text</span><span class="p">(</span>
                <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">waypoints_length_not_equal</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">val</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">logwarn_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Your joint trajectory goal message contains more or less joint &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">invalid_fields_string</span><span class="si">}</span><span class="s2"> than the </span><span class="si">{</span><span class="n">controlled_joints_size</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;joints that are found in the arm control group.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">InputMessageInvalidError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">logwarn_message</span><span class="p">,</span>
                <span class="n">log_message</span><span class="o">=</span><span class="n">logwarn_message</span><span class="p">,</span>
                <span class="n">joint_names_length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">input_joints</span><span class="p">),</span>
                <span class="n">error_code</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Validate joint_names and throw error if needed.</span>
        <span class="n">invalid_joint_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">joint_name</span>
            <span class="k">for</span> <span class="n">joint_name</span> <span class="ow">in</span> <span class="n">input_joints</span>
            <span class="k">if</span> <span class="n">joint_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">controlled_joints</span>
        <span class="p">]</span>
        <span class="n">invalid_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_joint_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Joint names invalid.</span>
            <span class="n">singular</span> <span class="o">=</span> <span class="n">invalid_count</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">joint_word</span> <span class="o">=</span> <span class="s2">&quot;Joint&quot;</span> <span class="k">if</span> <span class="n">singular</span> <span class="k">else</span> <span class="s2">&quot;Joints&quot;</span>
            <span class="n">verb</span> <span class="o">=</span> <span class="s2">&quot;was&quot;</span> <span class="k">if</span> <span class="n">singular</span> <span class="k">else</span> <span class="s2">&quot;were&quot;</span>
            <span class="n">logwarn_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">joint_word</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_joint_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; that </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;specified in the &#39;joint_names&#39; field of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;panda_gazebo/SetJointPositions&#39; message </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> invalid. Valid joint &quot;</span>
                <span class="s2">&quot;names for controlling the Panda arm are &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">controlled_joints</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">InputMessageInvalidError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid joint_names were given.&quot;</span><span class="p">,</span>
                <span class="n">log_message</span><span class="o">=</span><span class="n">logwarn_message</span><span class="p">,</span>
                <span class="n">invalid_joint_names</span><span class="o">=</span><span class="n">invalid_joint_names</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Iterates through waypoints to construct new joint trajectory control message.</span>
        <span class="c1"># NOTE: Empty fields are preserved for consistency with the original action</span>
        <span class="c1"># server except when &#39;autofill_traj_positions&#39; is set to True. In that case we</span>
        <span class="c1"># make sure to always populate &#39;positions&#39; with current joint states.</span>
        <span class="n">joint_to_index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">joint_name</span><span class="p">:</span> <span class="n">idx</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">joint_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">,</span> <span class="s2">&quot;velocities&quot;</span><span class="p">,</span> <span class="s2">&quot;accelerations&quot;</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">waypoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">):</span>
            <span class="n">input_command_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">attribute</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">input_joints</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">waypoint</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes</span>
            <span class="p">}</span>

            <span class="c1"># Add time_from_start variable if time axis should be created.</span>
            <span class="k">if</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">create_time_axis</span><span class="p">:</span>
                <span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span>
                    <span class="n">idx</span>
                <span class="p">]</span><span class="o">.</span><span class="n">time_from_start</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">from_sec</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">time_axis_step</span>
                <span class="p">)</span>

            <span class="c1"># Add joint commands.</span>
            <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">waypoint</span><span class="p">,</span> <span class="n">attribute</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">input_command_dict</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">joint_to_index</span><span class="p">:</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">attribute</span><span class="p">)[</span>
                                <span class="n">joint_to_index</span><span class="p">[</span><span class="n">joint</span><span class="p">]</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Make sure empty field stays empty.</span>
                    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="s2">&quot;positions&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autofill_traj_positions</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span>
                            <span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">attribute</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span>
                            <span class="n">arm_control_msg</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">attribute</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">panda_action_msg_2_control_msgs_action_msg</span><span class="p">(</span><span class="n">arm_control_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_arm_control_publisher_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_msg</span><span class="p">,</span> <span class="n">control_type</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts the input message of the arm position/effort control service into a</span>
<span class="sd">        control commands that is used by the control publishers. While doing this it</span>
<span class="sd">        also verifies whether the given input message is valid.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_msg (union[:obj:`panda_gazebo.msgs.SetJointPositions`, :obj:`panda_gazebo.msgs.SetJointEfforts`]):</span>
<span class="sd">                The service input message we want to convert and validate.</span>
<span class="sd">            control_type (str): The type of control that is being executed. Options</span>
<span class="sd">                are ``effort`` and ``position``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The Panda arm control commands in the order which is are required by</span>
<span class="sd">                the publishers.</span>

<span class="sd">        Raises:</span>
<span class="sd">            :obj:`panda_gazebo.exceptions.InputMessageInvalidError`: Raised when the</span>
<span class="sd">                input_msg could not be converted into arm joint position/effort</span>
<span class="sd">                commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="n">valid_control_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">control_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_control_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid control type. Valid values are &#39;position&#39; &amp; &#39;effort&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Parse control input.</span>
        <span class="n">control_type</span> <span class="o">=</span> <span class="n">control_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">input_joints</span> <span class="o">=</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">joint_names</span>
        <span class="n">control_input</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">input_msg</span><span class="o">.</span><span class="n">joint_positions</span>
            <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
            <span class="k">else</span> <span class="n">input_msg</span><span class="o">.</span><span class="n">joint_efforts</span>
        <span class="p">)</span>

        <span class="c1"># Retrieve controlled joints and current joint state.</span>
        <span class="n">controlled_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlled_joints</span><span class="p">[</span><span class="n">control_type</span><span class="p">][</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
        <span class="n">joint_values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">position</span>
            <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">effort</span>
        <span class="p">)</span>
        <span class="n">arm_commands_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">joint_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">controlled_joints</span>
        <span class="p">}</span>

        <span class="c1"># Handle the case when no joint_names were given.</span>
        <span class="n">controlled_joints_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">controlled_joints</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_joints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Check if enough joint position commands were given otherwise give warning.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">)</span> <span class="o">!=</span> <span class="n">controlled_joints_size</span><span class="p">:</span>
                <span class="n">joint_str</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;joint </span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;joint </span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">s&quot;</span>
                <span class="p">)</span>
                <span class="n">joint_names_str</span> <span class="o">=</span> <span class="s2">&quot;joint&quot;</span> <span class="k">if</span> <span class="n">controlled_joints_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;joints&quot;</span>

                <span class="c1"># Check if control input is bigger than controllable joints.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">)</span> <span class="o">!=</span> <span class="n">controlled_joints_size</span><span class="p">:</span>
                    <span class="n">logwarn_message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;You specified </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">joint_str</span><span class="si">}</span><span class="s2"> while the &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Panda arm control group has </span><span class="si">{</span><span class="n">controlled_joints_size</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">joint_names_str</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">controlled_joints_size</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InputMessageInvalidError</span><span class="p">(</span>
                            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid number of joint </span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2"> commands.&quot;</span><span class="p">,</span>
                            <span class="n">log_message</span><span class="o">=</span><span class="n">logwarn_message</span><span class="p">,</span>
                            <span class="n">joint_commands_length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">),</span>
                            <span class="n">controlled_joints</span><span class="o">=</span><span class="n">controlled_joints_size</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logwarn_message</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot; As a result only joints &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">controlled_joints</span><span class="p">[:</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">)]</span><span class="si">}</span><span class="s2"> will be &quot;</span>
                            <span class="s2">&quot;controlled.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="n">logwarn_message</span><span class="p">)</span>

                        <span class="c1"># Add control commands to arm command dict.</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">arm_commands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">control_input</span><span class="p">):</span>
                            <span class="n">arm_commands_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">return</span> <span class="n">Float64MultiArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">arm_commands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="c1"># Throw warning if not enough joint commands commands were given.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_joints</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">):</span>
            <span class="n">joint_str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;joint </span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;joint </span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">s&quot;</span>
            <span class="p">)</span>
            <span class="n">joint_names_str</span> <span class="o">=</span> <span class="s2">&quot;joint&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_joints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;joints&quot;</span>
            <span class="n">logwarn_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;You specified </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">joint_str</span><span class="si">}</span><span class="s2"> while the &quot;</span>
                <span class="s2">&quot;&#39;joint_names&#39; field of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;panda_gazebo/SetJoint</span><span class="si">{</span><span class="n">control_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">s&#39; message &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;contains </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_joints</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">joint_names_str</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please make sure you supply a </span><span class="si">{</span><span class="n">joint_str</span><span class="si">}</span><span class="s2"> for each of the joints &quot;</span>
                <span class="s2">&quot;contained in the &#39;joint_names&#39; field.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">InputMessageInvalidError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The &#39;joint_names&#39; and &#39;joint_</span><span class="si">{</span><span class="n">control_type</span><span class="si">}</span><span class="s2">s&#39; fields of the &quot;</span>
                    <span class="s2">&quot;input message are of different lengths.&quot;</span>
                <span class="p">),</span>
                <span class="n">log_message</span><span class="o">=</span><span class="n">logwarn_message</span><span class="p">,</span>
                <span class="n">joint_commands_length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">control_input</span><span class="p">),</span>
                <span class="n">joint_names_length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">input_joints</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Throw error if joint_names are invalid.</span>
        <span class="n">invalid_joint_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">joint_name</span>
            <span class="k">for</span> <span class="n">joint_name</span> <span class="ow">in</span> <span class="n">input_joints</span>
            <span class="k">if</span> <span class="n">joint_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">controlled_joints</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">invalid_joint_names</span><span class="p">:</span>  <span class="c1"># Joint names invalid.</span>
            <span class="n">joint_str</span> <span class="o">=</span> <span class="s2">&quot;Joint&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_joint_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;Joints&quot;</span>
            <span class="n">was_were</span> <span class="o">=</span> <span class="s2">&quot;was&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_joint_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;were&quot;</span>
            <span class="n">logwarn_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">joint_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">invalid_joint_names</span><span class="si">}</span><span class="s2"> that </span><span class="si">{</span><span class="n">was_were</span><span class="si">}</span><span class="s2"> specified in &quot;</span>
                <span class="s2">&quot;the &#39;joint_names&#39; field of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;panda_gazebo/SetJoint</span><span class="si">{</span><span class="n">control_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; message &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">was_were</span><span class="si">}</span><span class="s2"> invalid. Valid joint names for controlling the Panda &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;arm are </span><span class="si">{</span><span class="n">controlled_joints</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">InputMessageInvalidError</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid joint_names were given.&quot;</span><span class="p">,</span>
                <span class="n">log_message</span><span class="o">=</span><span class="n">logwarn_message</span><span class="p">,</span>
                <span class="n">invalid_joint_names</span><span class="o">=</span><span class="n">invalid_joint_names</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Add control commands to arm command dict.</span>
        <span class="k">for</span> <span class="n">joint</span><span class="p">,</span> <span class="n">command</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_joints</span><span class="p">,</span> <span class="n">control_input</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">arm_commands_dict</span><span class="p">:</span>
                <span class="n">arm_commands_dict</span><span class="p">[</span><span class="n">joint</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span>

        <span class="c1"># Return command message.</span>
        <span class="k">return</span> <span class="n">Float64MultiArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">arm_commands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">_split_joint_commands_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_commands_req</span><span class="p">,</span> <span class="n">control_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Splits the combined :obj:`~panda_gazebo.msg.SetJointControlCommandRequest`</span>
<span class="sd">        message into separate arm and gripper messages.</span>

<span class="sd">        Args:</span>
<span class="sd">            joint_commands_req (:obj:`~panda_gazebo.msg.SetJointControlCommandRequest`):</span>
<span class="sd">                The joint control command message.</span>
<span class="sd">            control_type (str): The type of control that is being executed. Options are</span>
<span class="sd">                ``effort``, ``position`` and ``trajectory``</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>
<span class="sd">                - union[:obj:`~panda_gazebo.msg.SetJointPositionsRequest`, :obj:`~panda_gazebo.msg.SetJointEffortsRequest`, ``None``]:</span>
<span class="sd">                    The arm set joint position/effort message or ``None`` if no</span>
<span class="sd">                    joint positions/efforts were found in the joint control command.</span>
<span class="sd">                - union[:obj:`~panda_gazebo.msg.SetGripperWidth`, ``None``]: The gripper</span>
<span class="sd">                    action goal message or ``None`` if &#39;gripper_width&#39; was not found in</span>
<span class="sd">                    the joint control command.</span>

<span class="sd">        Raises:</span>
<span class="sd">            :obj:`ValueError`: Raised when the control_type is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="c1"># Validate control type</span>
        <span class="k">if</span> <span class="n">control_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Please specify a valid control type. Valid values are &#39;position&#39; &amp; &quot;</span>
                <span class="s2">&quot;&#39;effort&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate joint commands.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_commands_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">joint_commands_req</span><span class="o">.</span><span class="n">joint_commands</span>
        <span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                <span class="s2">&quot;The length of the joints command &#39;joint_names&#39; array is &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_commands_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> while the length of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;joint_commands&#39; array is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">joint_commands_req</span><span class="o">.</span><span class="n">joint_commands</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;As a result not all joint commands will be applied.&quot;</span>
            <span class="p">)</span>
        <span class="n">valid_joints</span> <span class="o">=</span> <span class="n">PANDA_JOINTS</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;gripper_width&quot;</span><span class="p">,</span> <span class="s2">&quot;gripper_max_effort&quot;</span><span class="p">]</span>
        <span class="n">invalid_joints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">joint</span>
            <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">joint_commands_req</span><span class="o">.</span><span class="n">joint_names</span>
            <span class="k">if</span> <span class="n">joint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_joints</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">invalid_joints</span><span class="p">:</span>
            <span class="n">joint_word</span> <span class="o">=</span> <span class="s2">&quot;Joint&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_joints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;Joints&quot;</span>
            <span class="n">validity_word</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;it is not a valid&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_joints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="s2">&quot;they are not valid&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">joint_word</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">invalid_joints</span><span class="si">}</span><span class="s2"> will be ignored since </span><span class="si">{</span><span class="n">validity_word</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;panda control joint. Valid control joints are </span><span class="si">{</span><span class="n">valid_joints</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Create arm and hand control messages.</span>
        <span class="n">joint_commands_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">joint_commands_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">,</span> <span class="n">joint_commands_req</span><span class="o">.</span><span class="n">joint_commands</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">arm_joint_commands_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">val</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">joint_commands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">PANDA_JOINTS</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">gripper_width_command</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">val</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">joint_commands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gripper_width&quot;</span>
            <span class="p">),</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">gripper_max_effort_command</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">val</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">joint_commands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gripper_max_effort&quot;</span>
            <span class="p">),</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">arm_req</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">arm_joint_commands_dict</span><span class="p">:</span>
            <span class="n">arm_req</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">SetJointPositions</span><span class="p">()</span> <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span> <span class="k">else</span> <span class="n">SetJointEfforts</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">arm_req</span><span class="o">.</span><span class="n">joint_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arm_joint_commands_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">arm_req</span><span class="o">.</span><span class="n">joint_positions</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">arm_joint_commands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">arm_req</span><span class="o">.</span><span class="n">joint_efforts</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">arm_joint_commands_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;effort&quot;</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">arm_req</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">joint_commands_req</span><span class="o">.</span><span class="n">arm_wait</span>
        <span class="n">gripper_req</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">gripper_width_command</span> <span class="ow">or</span> <span class="n">gripper_max_effort_command</span><span class="p">:</span>
            <span class="n">gripper_req</span> <span class="o">=</span> <span class="n">SetGripperWidthRequest</span><span class="p">()</span>
            <span class="n">gripper_req</span><span class="o">.</span><span class="n">grasping</span> <span class="o">=</span> <span class="n">joint_commands_req</span><span class="o">.</span><span class="n">grasping</span>
            <span class="n">gripper_req</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">joint_commands_req</span><span class="o">.</span><span class="n">hand_wait</span>
            <span class="k">if</span> <span class="n">gripper_width_command</span><span class="p">:</span>
                <span class="n">gripper_req</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">gripper_width_command</span>
            <span class="k">if</span> <span class="n">gripper_max_effort_command</span><span class="p">:</span>
                <span class="n">gripper_req</span><span class="o">.</span><span class="n">max_effort</span> <span class="o">=</span> <span class="n">gripper_max_effort_command</span>

        <span class="k">return</span> <span class="n">arm_req</span><span class="p">,</span> <span class="n">gripper_req</span>

    <span class="k">def</span> <span class="nf">_controllers_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controllers</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if all controllers that are needed for controlling a given control</span>
<span class="sd">        group are running.</span>

<span class="sd">        Args:</span>
<span class="sd">            controllers (list): A list of controllers for which you want to check if</span>
<span class="sd">                they are running.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - missing_controllers (:obj:`list`): The controllers that are not</span>
<span class="sd">                    loaded.</span>
<span class="sd">                - stopped_controllers (:obj:`list`): The controllers that are loaded but</span>
<span class="sd">                    not started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">missing_controllers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">controller</span>
            <span class="k">for</span> <span class="n">controller</span> <span class="ow">in</span> <span class="n">controllers</span>
            <span class="k">if</span> <span class="n">controller</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controllers</span>
        <span class="p">]</span>
        <span class="n">stopped_controllers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">controller</span>
            <span class="k">for</span> <span class="n">controller</span> <span class="ow">in</span> <span class="n">controllers</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s2">&quot;running&quot;</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">missing_controllers</span><span class="p">,</span> <span class="n">stopped_controllers</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaControlServer.arm_trajectory_action_preempted"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.PandaControlServer.arm_trajectory_action_preempted">[docs]</a>    <span class="k">def</span> <span class="nf">arm_trajectory_action_preempted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns whether the arm joint trajectory action server is preempted.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span><span class="o">.</span><span class="n">is_preempt_requested</span><span class="p">()</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="n">GoalStatus</span><span class="o">.</span><span class="n">PREEMPTED</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaControlServer.controlled_joints"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.PandaControlServer.controlled_joints">[docs]</a>    <span class="k">def</span> <span class="nf">controlled_joints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the joints that can be controlled by a each control type.</span>

<span class="sd">        .. important::</span>
<span class="sd">            This does not mean that the necessary controller is running. It only means</span>
<span class="sd">            that the controller was loaded and can be used to control the joints when</span>
<span class="sd">            it is started.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the joints that are controlled when using a</span>
<span class="sd">                given control type</span>
<span class="sd">                (i.e. ``control_type``&gt;``control_group``&gt;``controller``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__controlled_joints</span><span class="p">:</span>
            <span class="n">controllers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controllers</span>
            <span class="n">controlled_joints_dict</span> <span class="o">=</span> <span class="n">ControlledJointsDict</span><span class="p">()</span>

            <span class="c1"># Retrieve the arm joints that can be controlled by each controller.</span>
            <span class="n">controller_types</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">ARM_POSITION_CONTROLLER</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">ARM_EFFORT_CONTROLLER</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">ARM_TRAJ_CONTROLLER</span><span class="p">,</span> <span class="s2">&quot;trajectory&quot;</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">controller</span><span class="p">,</span> <span class="n">control_type</span> <span class="ow">in</span> <span class="n">controller_types</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">claimed_resources</span> <span class="ow">in</span> <span class="n">controllers</span><span class="p">[</span><span class="n">controller</span><span class="p">]</span><span class="o">.</span><span class="n">claimed_resources</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">claimed_resources</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
                            <span class="n">controlled_joints_dict</span><span class="p">[</span><span class="n">control_type</span><span class="p">][</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
                            <span class="n">controlled_joints_dict</span><span class="p">[</span><span class="n">control_type</span><span class="p">][</span><span class="s2">&quot;both&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">resource</span>
                            <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># Controller not loaded.</span>
                    <span class="k">pass</span>

            <span class="c1"># Retrieve hand joints that can be controlled by the hand controller.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">claimed_resources</span> <span class="ow">in</span> <span class="n">controllers</span><span class="p">[</span><span class="n">HAND_CONTROLLER</span><span class="p">]</span><span class="o">.</span><span class="n">claimed_resources</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">claimed_resources</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
                        <span class="n">controlled_joints_dict</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">][</span><span class="s2">&quot;hand&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
                        <span class="n">controlled_joints_dict</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">][</span><span class="s2">&quot;both&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># Controller not loaded.</span>
                <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__controlled_joints</span> <span class="o">=</span> <span class="n">controlled_joints_dict</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__controlled_joints</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaControlServer.joint_controllers"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.PandaControlServer.joint_controllers">[docs]</a>    <span class="k">def</span> <span class="nf">joint_controllers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the controllers which are currently loaded to control each</span>
<span class="sd">        joint.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary where the keys are joint names and the values are</span>
<span class="sd">                lists of controllers that can control the joint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__joint_controllers</span><span class="p">:</span>
            <span class="n">joint_controllers_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">controller</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controllers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">resources_item</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">claimed_resources</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources_item</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
                        <span class="n">joint_controllers_dict</span><span class="p">[</span><span class="n">resource</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__joint_controllers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">joint_controllers_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__joint_controllers</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaControlServer.controllers"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.PandaControlServer.controllers">[docs]</a>    <span class="k">def</span> <span class="nf">controllers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves info about the loaded controllers.</span>

<span class="sd">        .. note:: This method is cached to reduce the number of calls to the</span>
<span class="sd">            controller manager and therefore increase performance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary with information about the currently loaded controllers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__controller_check_t</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_controllers_check_rate</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__controllers</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__controllers</span> <span class="o">=</span> <span class="n">controller_list_array_2_dict</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_list_controllers_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ListControllersRequest</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__joint_controllers</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Trigger refresh.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__controlled_joints</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Trigger refresh.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__controller_check_t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__controllers</span></div>

    <span class="nd">@property</span>
<div class="viewcode-block" id="PandaControlServer.gripper_width"><a class="viewcode-back" href="../../../autoapi/panda_gazebo/core/control_server/index.html#panda_gazebo.core.control_server.PandaControlServer.gripper_width">[docs]</a>    <span class="k">def</span> <span class="nf">gripper_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the gripper width as calculated based on the Panda finger joints.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The gripper width.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span><span class="o">.</span><span class="n">position</span><span class="p">))[</span>
                <span class="s2">&quot;panda_finger_joint1&quot;</span>
            <span class="p">]</span>
            <span class="o">*</span> <span class="mi">2</span>
        <span class="p">)</span></div>

    <span class="c1">################################################</span>
    <span class="c1"># Subscribers callback functions ###############</span>
    <span class="c1">################################################</span>
    <span class="k">def</span> <span class="nf">_joint_states_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Callback function for the joint data subscriber.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">joint_states</span> <span class="o">=</span> <span class="n">data</span>

    <span class="c1">################################################</span>
    <span class="c1"># Control services callback functions ##########</span>
    <span class="c1">################################################</span>
    <span class="k">def</span> <span class="nf">_set_joint_commands_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_joint_commands_req</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request arm and hand joint command control.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The gripper `max_effort` is determined based on the `grasping` field if it&#39;s</span>
<span class="sd">            set to `0`. Specifically, if `grasping` is `True`, `max_effort` is set to</span>
<span class="sd">            10N. Otherwise, it remains at `0`.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_joint_commands_req (:obj:`panda_gazebo.srv.SetJointPositionsRequest`):</span>
<span class="sd">                Service request message specifying the joint position/effort commands</span>
<span class="sd">                for the robot arm and hand joints.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`panda_gazebo.srv.SetJointCommandsResponse`: Service response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">SetJointCommandsResponse</span><span class="p">()</span>
        <span class="n">control_type</span> <span class="o">=</span> <span class="n">set_joint_commands_req</span><span class="o">.</span><span class="n">control_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">control_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;effort&quot;</span><span class="p">]:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Please specify a valid control type. Valid values are &#39;position&#39; &amp; &quot;</span>
                <span class="s2">&quot;&#39;effort&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Specified &#39;control_type&#39; invalid.&quot;</span>
            <span class="k">return</span> <span class="n">resp</span>

        <span class="c1"># Split input message and send arm and gripper control commands.</span>
        <span class="n">arm_command_msg</span><span class="p">,</span> <span class="n">gripper_command_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_joint_commands_req</span><span class="p">(</span>
            <span class="n">set_joint_commands_req</span><span class="p">,</span> <span class="n">control_type</span>
        <span class="p">)</span>

        <span class="c1"># Send arm control commands.</span>
        <span class="n">arm_resp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">arm_command_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arm_resp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_arm_set_joint_positions_cb</span><span class="p">(</span><span class="n">arm_command_msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">control_type</span> <span class="o">==</span> <span class="s2">&quot;position&quot;</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_set_joint_efforts_cb</span><span class="p">(</span><span class="n">arm_command_msg</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Send gripper control commands.</span>
        <span class="n">gripper_resp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">gripper_command_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span><span class="p">:</span>
                <span class="n">gripper_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_gripper_width_cb</span><span class="p">(</span><span class="n">gripper_command_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Gripper command could not be set since the &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                    <span class="s2">&quot;gripper services were not loaded. Please set the &#39;load_gripper` &quot;</span>
                    <span class="s2">&quot;argument to `True` if you want to control the gripper through the &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Check if everything went OK and return response.</span>
        <span class="n">arm_control_failed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">arm_command_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">arm_resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">arm_resp</span><span class="o">.</span><span class="n">success</span>
        <span class="p">)</span>
        <span class="n">gripper_control_failed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_gripper</span>
            <span class="ow">and</span> <span class="n">gripper_command_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">gripper_resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">gripper_resp</span><span class="o">.</span><span class="n">success</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">arm_control_failed</span> <span class="ow">and</span> <span class="n">gripper_control_failed</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Joint control failed&quot;</span>
        <span class="k">elif</span> <span class="n">arm_control_failed</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Arm control failed&quot;</span>
        <span class="k">elif</span> <span class="n">gripper_control_failed</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Gripper control failed&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Everything went OK&quot;</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="k">def</span> <span class="nf">_arm_set_joint_positions_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_joint_positions_req</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request arm joint position control.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_joint_positions_req (:obj:`panda_gazebo.srv.SetJointPositionsRequest`):</span>
<span class="sd">                Service request message specifying the positions for the robot arm</span>
<span class="sd">                joints.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`panda_gazebo.srv.SetJointPositionsResponse`: Service response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">duplicate_list</span> <span class="o">=</span> <span class="n">get_duplicate_list</span><span class="p">(</span><span class="n">set_joint_positions_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">duplicate_list</span><span class="p">:</span>
            <span class="n">joint_word</span> <span class="o">=</span> <span class="s2">&quot;joints&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;joint&quot;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Multiple entries were found for </span><span class="si">{</span><span class="n">joint_word</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">duplicate_list</span><span class="si">}</span><span class="s2">&#39; in &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">/panda_arm/set_joint_positions&#39; message. &quot;</span>
                <span class="s2">&quot;Consequently, only the first occurrence was used in setting the joint &quot;</span>
                <span class="s2">&quot;positions.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Remove duplicate entries.</span>
            <span class="n">joint_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">joint_name</span><span class="p">,</span> <span class="n">joint_position</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">set_joint_positions_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">,</span>
                <span class="n">set_joint_positions_req</span><span class="o">.</span><span class="n">joint_positions</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">joint_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joint_dict</span><span class="p">:</span>
                    <span class="n">joint_dict</span><span class="p">[</span><span class="n">joint_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint_position</span>
            <span class="n">set_joint_positions_req</span><span class="o">.</span><span class="n">joint_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">set_joint_positions_req</span><span class="o">.</span><span class="n">joint_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># Check if all controllers are available and running.</span>
        <span class="c1"># NOTE: Fail if is missing and display warning if not started.</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">SetJointPositionsResponse</span><span class="p">()</span>
        <span class="n">missing_controllers</span><span class="p">,</span> <span class="n">stopped_controllers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controllers_running</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ARM_POSITION_CONTROLLER</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_controllers</span><span class="p">:</span>
            <span class="n">controller_word</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;controller is&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_controllers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;controllers are&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Panda arm joint position command could not be sent as the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">missing_controllers</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">controller_word</span><span class="si">}</span><span class="s2"> not loaded. Please make &quot;</span>
                <span class="s2">&quot;sure you load the controller parameters onto the ROS parameter server.&quot;</span>
            <span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Arm controllers not loaded.&quot;</span>
            <span class="k">return</span> <span class="n">resp</span>
        <span class="k">if</span> <span class="n">stopped_controllers</span><span class="p">:</span>
            <span class="c1"># Check if these controllers are required for the current command.</span>
            <span class="n">required_stopped_controllers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">set_joint_positions_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">:</span>
                <span class="n">required_stopped_controllers</span> <span class="o">=</span> <span class="n">stopped_controllers</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">set_joint_positions_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_controllers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">stopped_controller</span> <span class="ow">in</span> <span class="n">stopped_controllers</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">stopped_controller</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_controllers</span><span class="p">[</span><span class="n">joint</span><span class="p">]:</span>
                                <span class="n">required_stopped_controllers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stopped_controller</span><span class="p">)</span>
                <span class="n">required_stopped_controllers</span> <span class="o">=</span> <span class="n">get_unique_list</span><span class="p">(</span>
                    <span class="n">required_stopped_controllers</span>
                <span class="p">)</span>

            <span class="c1"># Display warning if required controllers are not running.</span>
            <span class="k">if</span> <span class="n">required_stopped_controllers</span><span class="p">:</span>
                <span class="n">controller_word</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;controller is&quot;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_stopped_controllers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="s2">&quot;controllers are&quot;</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Panda arm joint positions command sent but probably not executed &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;as the </span><span class="si">{</span><span class="n">required_stopped_controllers</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">controller_word</span><span class="si">}</span><span class="s2"> not &quot;</span>
                    <span class="s2">&quot;running.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Validate request and publish control command.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">control_pub_msgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_arm_control_publisher_msg</span><span class="p">(</span>
                <span class="n">input_msg</span><span class="o">=</span><span class="n">set_joint_positions_req</span><span class="p">,</span>
                <span class="n">control_type</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">InputMessageInvalidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logwarn_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Panda arm joint positions not set as &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lower_first_char</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">log_message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="n">logwarn_msg</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">resp</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Publishing Panda arm joint positions control message.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_position_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">control_pub_msgs</span><span class="p">)</span>

        <span class="c1"># Wait till control is finished or timeout has been reached.</span>
        <span class="k">if</span> <span class="n">set_joint_positions_req</span><span class="o">.</span><span class="n">wait</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stopped_controllers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_till_arm_control_done</span><span class="p">(</span>
                <span class="n">control_type</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
                <span class="n">joint_setpoint</span><span class="o">=</span><span class="n">control_pub_msgs</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Everything went OK&quot;</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="k">def</span> <span class="nf">_arm_set_joint_efforts_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_joint_efforts_req</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request arm Joint effort control.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_joint_efforts_req (:obj:`panda_gazebo.srv.SetJointEffortsRequest`):</span>
<span class="sd">                Service request message specifying the efforts for the robot arm joints.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`panda_gazebo.srv.SetJointEffortsResponse`: Service response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">duplicate_list</span> <span class="o">=</span> <span class="n">get_duplicate_list</span><span class="p">(</span><span class="n">set_joint_efforts_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">duplicate_list</span><span class="p">:</span>
            <span class="n">joint_word</span> <span class="o">=</span> <span class="s2">&quot;joints&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;joint&quot;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Multiple entries were found for </span><span class="si">{</span><span class="n">joint_word</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">duplicate_list</span><span class="si">}</span><span class="s2">&#39; in &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;the &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">/panda_arm/set_joint_efforts&#39; message. &quot;</span>
                <span class="s2">&quot;Consequently, only the first occurrence was used in setting the joint &quot;</span>
                <span class="s2">&quot;efforts.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Remove duplicate entries.</span>
            <span class="n">joint_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">joint_name</span><span class="p">,</span> <span class="n">joint_effort</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">set_joint_efforts_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">,</span> <span class="n">set_joint_efforts_req</span><span class="o">.</span><span class="n">joint_efforts</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">joint_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joint_dict</span><span class="p">:</span>
                    <span class="n">joint_dict</span><span class="p">[</span><span class="n">joint_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint_effort</span>
            <span class="n">set_joint_efforts_req</span><span class="o">.</span><span class="n">joint_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">set_joint_efforts_req</span><span class="o">.</span><span class="n">joint_efforts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">joint_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># Check if all controllers are available and running.</span>
        <span class="c1"># NOTE: Fail if is missing and display warning if not started.</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">SetJointEffortsResponse</span><span class="p">()</span>
        <span class="n">missing_controllers</span><span class="p">,</span> <span class="n">stopped_controllers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_controllers_running</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ARM_EFFORT_CONTROLLER</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_controllers</span><span class="p">:</span>
            <span class="n">controller_word</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;controller is&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_controllers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;controllers are&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Panda arm joint effort command could not be send as the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">missing_controllers</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">controller_word</span><span class="si">}</span><span class="s2"> not loaded. Please make &quot;</span>
                <span class="s2">&quot;sure you load the controller parameters onto the ROS parameter server.&quot;</span>
            <span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Arm controllers not loaded.&quot;</span>
            <span class="k">return</span> <span class="n">resp</span>
        <span class="k">if</span> <span class="n">stopped_controllers</span><span class="p">:</span>
            <span class="c1"># Check if these controllers are required for the current command.</span>
            <span class="n">required_stopped_controllers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">set_joint_efforts_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">:</span>
                <span class="n">required_stopped_controllers</span> <span class="o">=</span> <span class="n">stopped_controllers</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">joint</span> <span class="ow">in</span> <span class="n">set_joint_efforts_req</span><span class="o">.</span><span class="n">joint_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">joint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_controllers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">stopped_controller</span> <span class="ow">in</span> <span class="n">stopped_controllers</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">stopped_controller</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_controllers</span><span class="p">[</span><span class="n">joint</span><span class="p">]:</span>
                                <span class="n">required_stopped_controllers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stopped_controller</span><span class="p">)</span>
                <span class="n">required_stopped_controllers</span> <span class="o">=</span> <span class="n">get_unique_list</span><span class="p">(</span>
                    <span class="n">required_stopped_controllers</span>
                <span class="p">)</span>

            <span class="c1"># Display warning if required controllers are not running.</span>
            <span class="k">if</span> <span class="n">required_stopped_controllers</span><span class="p">:</span>
                <span class="n">controller_word</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;controller is&quot;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">required_stopped_controllers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="s2">&quot;controllers are&quot;</span>
                <span class="p">)</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Panda arm joint efforts command sent but probably not executed &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;as the </span><span class="si">{</span><span class="n">required_stopped_controllers</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">controller_word</span><span class="si">}</span><span class="s2"> not &quot;</span>
                    <span class="s2">&quot;running.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Validate request and publish control command.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">control_pub_msgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_arm_control_publisher_msg</span><span class="p">(</span>
                <span class="n">input_msg</span><span class="o">=</span><span class="n">set_joint_efforts_req</span><span class="p">,</span>
                <span class="n">control_type</span><span class="o">=</span><span class="s2">&quot;effort&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">InputMessageInvalidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logwarn_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Panda arm joint efforts not set as </span><span class="si">{</span><span class="n">lower_first_char</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">log_message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="n">logwarn_msg</span><span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">resp</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">logdebug</span><span class="p">(</span><span class="s2">&quot;Publishing Panda arm joint efforts control message.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_effort_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">control_pub_msgs</span><span class="p">)</span>

        <span class="c1"># Wait till control is finished or timeout has been reached.</span>
        <span class="c1"># NOTE: We currently do not have to wait for control efforts to be applied</span>
        <span class="c1"># since the &#39;FrankaHWSim&#39; does not yet implement control latency. Torques</span>
        <span class="c1"># are therefore applied instantly.</span>
        <span class="c1"># if set_joint_efforts_req.wait and not stopped_controllers:</span>
        <span class="c1">#     self._wait_till_arm_control_done(</span>
        <span class="c1">#         control_type=&quot;effort&quot;,</span>
        <span class="c1">#         joint_setpoint=control_pub_msgs.data,</span>
        <span class="c1">#     )</span>

        <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Everything went OK&quot;</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="k">def</span> <span class="nf">_set_gripper_width_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_gripper_width_req</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request gripper width.</span>

<span class="sd">        .. note::</span>
<span class="sd">            The gripper `max_effort` is determined based on the `grasping` field if it&#39;s</span>
<span class="sd">            set to `0`. Specifically, if `grasping` is `True`, `max_effort` is set to</span>
<span class="sd">            10N. Otherwise, it remains at `0`.</span>

<span class="sd">        Args:</span>
<span class="sd">            set_gripper_width_req (:obj:`panda_gazebo.srv.SetGripperWidth`):</span>
<span class="sd">                Service request message specifying the gripper width for the robot hand.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`panda_gazebo.srv.SetGripperWidthResponse`: Service response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">SetGripperWidthResponse</span><span class="p">()</span>

        <span class="c1"># Check if gripper width is within boundaries and convert to finger position.</span>
        <span class="n">set_gripper_width_req</span><span class="o">.</span><span class="n">width</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="n">gripper_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">set_gripper_width_req</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gripper_width</span> <span class="o">!=</span> <span class="n">set_gripper_width_req</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Gripper width was clipped as it was not within bounds [0, 0.08].&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Create gripper command action message.</span>
        <span class="c1"># NOTE: The max_effort has to be 0 for the gripper to be able to move (see #33).</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">GripperCommandGoal</span><span class="p">()</span>
        <span class="n">req</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">gripper_width</span>
        <span class="n">req</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">max_effort</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">set_gripper_width_req</span><span class="o">.</span><span class="n">max_effort</span>
            <span class="k">if</span> <span class="n">set_gripper_width_req</span><span class="o">.</span><span class="n">max_effort</span> <span class="o">!=</span> <span class="mf">0.0</span>
            <span class="k">else</span> <span class="n">GRASP_FORCE</span>
            <span class="k">if</span> <span class="n">set_gripper_width_req</span><span class="o">.</span><span class="n">grasping</span>
            <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">)</span>

        <span class="c1"># Invoke &#39;franka_gripper&#39; action service</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client_connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

            <span class="c1"># Wait for result.</span>
            <span class="k">if</span> <span class="n">set_gripper_width_req</span><span class="o">.</span><span class="n">wait</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_command_client</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">set_gripper_width_req</span><span class="o">.</span><span class="n">timeout</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="s2">&quot;Cloud not connect to franka_gripper/</span><span class="si">{}</span><span class="s2"> service.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s2">&quot;grasp&quot;</span> <span class="k">if</span> <span class="n">set_gripper_width_req</span><span class="o">.</span><span class="n">grasping</span> <span class="k">else</span> <span class="s2">&quot;move&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Add result message and return result.</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Everything went OK&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Gripper width could not be set&quot;</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="k">def</span> <span class="nf">_get_controlled_joints_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_controlled_joints_req</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the joints that are controlled when using a given control type.</span>

<span class="sd">        Args:</span>
<span class="sd">            get_controlled_joints_req (:obj:`panda_gazebo.srv.GetControlledJointsRequest`):</span>
<span class="sd">                The service request message specifying the control_type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :obj:`panda_gazebo.srv.GetControlledJointsResponse`: The response message</span>
<span class="sd">                that contains the ``controlled_joints`` list that specifies the joints</span>
<span class="sd">                that are controlled.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">GetControlledJointsResponse</span><span class="p">()</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Everything went OK&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__controlled_joints</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__controllers</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>  <span class="c1"># Trigger refresh.</span>
            <span class="n">controlled_joints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controlled_joints</span><span class="p">[</span>
                <span class="n">get_controlled_joints_req</span><span class="o">.</span><span class="n">control_type</span>
            <span class="p">]</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">controlled_joints</span> <span class="o">=</span> <span class="n">controlled_joints</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">]</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">controlled_joints_arm</span> <span class="o">=</span> <span class="n">controlled_joints</span><span class="p">[</span><span class="s2">&quot;arm&quot;</span><span class="p">]</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">controlled_joints_hand</span> <span class="o">=</span> <span class="n">controlled_joints</span><span class="p">[</span><span class="s2">&quot;hand&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Controlled joints could not be retrieved&quot;</span>
        <span class="k">return</span> <span class="n">resp</span>

    <span class="c1">################################################</span>
    <span class="c1"># Action server callback functions #############</span>
    <span class="c1">################################################</span>
    <span class="k">def</span> <span class="nf">_arm_joint_traj_execute_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Goal execution callback function for the Panda arm joint trajectory action</span>
<span class="sd">        server.</span>

<span class="sd">        Args:</span>
<span class="sd">            goal (:obj:`panda_gazebo.msg.FollowJointTrajectoryGoal`): Goal execution</span>
<span class="sd">                action server goal message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client_connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_aborted_result</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;Could not connect to original Panda arm action server.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Check if joint goal.joint_names contains duplicates</span>
        <span class="n">duplicate_list</span> <span class="o">=</span> <span class="n">get_duplicate_list</span><span class="p">(</span><span class="n">goal</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">joint_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">duplicate_list</span><span class="p">:</span>
            <span class="n">joint_word</span> <span class="o">=</span> <span class="s2">&quot;joints&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;joint&quot;</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Multiple entries were found for </span><span class="si">{</span><span class="n">joint_word</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">duplicate_list</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;in the &#39;</span><span class="si">{</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="si">}</span><span class="s2">/panda_arm/follow_joint_trajectory&#39; &quot;</span>
                <span class="s2">&quot;message. Consequently, only the first occurrence was used in &quot;</span>
                <span class="s2">&quot;setting the joint trajectory.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check the input goal message for errors and if valid convert it to.</span>
        <span class="c1"># the right format for the original panda joint trajectory action servers.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Convert input goal message to the right format.</span>
            <span class="n">goal_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_arm_traj_action_server_msg</span><span class="p">(</span><span class="n">goal</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InputMessageInvalidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span><span class="o">.</span><span class="n">set_aborted</span><span class="p">(</span>
                <span class="n">FollowJointTrajectoryResult</span><span class="p">(</span>
                    <span class="n">error_code</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;error_code&quot;</span><span class="p">],</span> <span class="n">error_string</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">log_message</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn_once</span><span class="p">(</span>
                <span class="s2">&quot;Joint trajectory control command failed because &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Send trajectory goal to the original Panda arm action servers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span>
            <span class="n">goal_msg</span><span class="p">,</span> <span class="n">feedback_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_feedback_cb</span>
        <span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">goal</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

        <span class="c1"># Handle timeout.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span><span class="o">.</span><span class="n">set_aborted</span><span class="p">(</span>
                <span class="n">FollowJointTrajectoryResult</span><span class="p">(</span>
                    <span class="n">error_code</span><span class="o">=-</span><span class="mi">6</span><span class="p">,</span>
                    <span class="n">error_string</span><span class="o">=</span><span class="s2">&quot;Goal was not executed within the given timeout.&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Retrieve original action server result and set it as result for this action.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">error_string</span> <span class="o">=</span> <span class="n">translate_actionclient_result_error_code</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_trajectory_action_preempted</span>
            <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">result</span><span class="o">.</span><span class="n">SUCCESSFUL</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span><span class="o">.</span><span class="n">set_succeeded</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If not successful or preempted.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span><span class="o">.</span><span class="n">set_aborted</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_arm_joint_traj_feedback_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Relays the feedback messages from the original</span>
<span class="sd">        ``panda_arm_trajectory_controller/follow_joint_trajectory`` server to our to our</span>
<span class="sd">        ``panda_control_server/panda_arm/follow_joint_trajectory`` wrapper action</span>
<span class="sd">        server.</span>

<span class="sd">        Args:</span>
<span class="sd">            feedback (:obj:`control_msgs.msg.FollowJointTrajectoryFeedback`): Goal</span>
<span class="sd">                execution action server feedback message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span><span class="o">.</span><span class="n">publish_feedback</span><span class="p">(</span><span class="n">feedback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_arm_joint_traj_preempt_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Relays the preempt request made to the</span>
<span class="sd">        ``panda_control_server/panda_arm/follow_joint_trajectory`` action server wrapper</span>
<span class="sd">        to the original ``panda_arm_trajectory_controller/follow_joint_trajectory``</span>
<span class="sd">        action server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Stop panda_arm_trajectory_controller action server.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">GoalStatus</span><span class="o">.</span><span class="n">PREEMPTING</span><span class="p">,</span>
            <span class="n">GoalStatus</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_client</span><span class="o">.</span><span class="n">cancel_goal</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arm_joint_traj_as</span><span class="o">.</span><span class="n">set_preempted</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Rick Staa.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>