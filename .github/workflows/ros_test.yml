name: ROS Test

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  ROS-test:
    runs-on: ubuntu-latest
    steps:
    - name: Prepare
    # Keep the compilation outputs persitant outside the docker container to use for the other steps
      run: |
        mkdir -p ${{github.workspace}}/src       # where the repo will be cloned into
        mkdir -p ${{github.workspace}}/build     
        mkdir -p ${{github.workspace}}/devel     

    - name: Checkout
      uses: actions/checkout@v3
      with:
        path: src
        submodules: true

    - name: Build Docker Image
      uses: docker/build-push-action@v2
      with:
        tags: panda_gazebo:noetic
        file: .ci/Dockerfile.noetic
        push: false
  
    - name: Compile ROS package with Catkin Tools
      uses: addnab/docker-run-action@v3
      with:
        image:    panda_gazebo:noetic
        options:  -v ${{github.workspace}}/src:/ros/src/  # only mount source here
        run: |
            catkin config --workspace /ros/ --init --extend /opt/ros/noetic --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
            catkin build --workspace /ros/ --interleave-output --verbose
